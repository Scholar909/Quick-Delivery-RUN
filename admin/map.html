<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Redeemer's University Merchant Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body, html {
      margin: 0;
      height: 100%;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
    }

    /* Map container with border */
    #mapContainer {
      flex: 1;
      margin: 10px;
      border: 2px solid #0f4e75;
      border-radius: 10px;
      overflow: hidden;
      position: relative;
    }

    #map {
      height: 100%;
      width: 100%;
    }

    /* Bottom merchant footer box */
    #merchantFooter {
      height: 100px;
      background: #f5f5f5;
      border-top: 2px solid #0f4e75;
      display: flex;
      align-items: center;
      padding: 10px;
      overflow-x: auto;
      gap: 10px;
    }

    .merchant-card {
      flex: 0 0 auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      transition: transform 0.2s, border 0.2s;
      border: 2px solid transparent;
      border-radius: 5px;
      padding: 2px;
    }
    .merchant-card:hover {
      transform: scale(1.1);
    }
    .merchant-card img {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 5px;
    }
    .merchant-card span {
      font-size: 12px;
      text-align: center;
      max-width: 60px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Highlight your own card */
    .my-card {
      border-color: #0f4e75;
    }

    #loadingOverlay {
      position: fixed;
      top: 0;
      left: 0;
      height: 100%;
      width: 100%;
      background: rgba(255, 255, 255, 0.95);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: #333;
    }

    .popup-content {
      text-align: center;
    }
    .popup-content img {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      margin-bottom: 5px;
      object-fit: cover;
    }
  </style>
</head>
<body>

<div id="loadingOverlay">
  <div>üìç Please enable your location to appear on the live map...</div>
  <div style="margin-top:10px; font-size:14px; color:#777;">
    This page will load once location is granted.
  </div>
</div>

<div id="mapContainer">
  <div id="map"></div>
</div>

<div id="merchantFooter"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script type="module">
  import { db, auth } from '../js/firebase.js';
  import { collection, onSnapshot, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

  const campusLat = 7.7416;
  const campusLng = 4.4432;

  let map;
  const merchantMarkers = {};
  const myMarker = { marker: null, name: "Me" };
  const footer = document.getElementById("merchantFooter");

  let myUid = null;

  function requestLocationAccess() {
    if (!navigator.geolocation) {
      alert("Geolocation not supported by browser.");
      return;
    }

    navigator.geolocation.getCurrentPosition(
      (pos) => {
        document.getElementById("loadingOverlay").style.display = "none";
        initMap();
        startLiveTracking(pos.coords.latitude, pos.coords.longitude);
        startMerchantListener();
      },
      (err) => {
        alert("Location required to use this page.");
        console.error(err);
      },
      { enableHighAccuracy: true }
    );
  }

  function initMap() {
    const lightLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OSM &copy; CARTO',
      subdomains: 'abcd',
      maxZoom: 19
    });

    const satelliteLayer = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      { attribution: 'Tiles &copy; Esri', maxZoom: 19 }
    );

    map = L.map('map', { center: [campusLat, campusLng], zoom: 16, layers: [lightLayer], maxZoom: 19 });
    L.control.layers({ "Light": lightLayer, "Satellite": satelliteLayer }).addTo(map);
    setTimeout(() => map.invalidateSize(), 100);
  }

  function startMerchantListener() {
    onSnapshot(collection(db, "merchants"), (snapshot) => {
      footer.innerHTML = ""; // clear footer
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        if (!data.lat || !data.lng) return;

        const popupHTML = `
          <div class="popup-content">
            <img src="${data.profileImage || 'https://via.placeholder.com/60'}" />
            <div><strong>${data.fullname || 'Unknown'}</strong></div>
          </div>
        `;

        // Map marker
        if (merchantMarkers[docSnap.id]) {
          merchantMarkers[docSnap.id].setLatLng([data.lat, data.lng])
            .setPopupContent(popupHTML);
        } else {
          const marker = L.marker([data.lat, data.lng]).addTo(map)
            .bindPopup(popupHTML);
          merchantMarkers[docSnap.id] = marker;
        }

        // Footer card
        const card = document.createElement("div");
        card.classList.add("merchant-card");
        if (docSnap.id === myUid) card.classList.add("my-card");

        card.innerHTML = `
          <img src="${data.profileImage || 'https://via.placeholder.com/50'}" />
          <span>${data.fullname || "Unknown"}</span>
        `;
        card.onclick = () => {
          map.setView([data.lat, data.lng], 18);
          merchantMarkers[docSnap.id].openPopup();
        };
        footer.appendChild(card);
      });

      // Insert my own card first
      if (myMarker.marker && myUid) {
        const myCard = document.createElement("div");
        myCard.classList.add("merchant-card", "my-card");
        myCard.innerHTML = `
          <img src="https://cdn-icons-png.flaticon.com/512/149/149060.png" />
          <span>${myMarker.name}</span>
        `;
        myCard.onclick = () => {
          map.setView(myMarker.marker.getLatLng(), 18);
          myMarker.marker.openPopup();
        };
        footer.prepend(myCard);
      }
    });
  }

  function startLiveTracking(lat, lng) {
    onAuthStateChanged(auth, (user) => {
      if (user) myUid = user.uid;

      const updateMyLocation = async (latitude, longitude) => {
        if (user) {
          await updateDoc(doc(db, "merchants", user.uid), { lat: latitude, lng: longitude });
        }

        if (!myMarker.marker) {
          const redIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/149/149060.png',
            iconSize: [35, 35],
            iconAnchor: [17, 35]
          });
          myMarker.marker = L.marker([latitude, longitude], { icon: redIcon }).addTo(map)
            .bindPopup(myMarker.name);
        } else {
          myMarker.marker.setLatLng([latitude, longitude]);
        }
      };

      updateMyLocation(lat, lng);

      navigator.geolocation.watchPosition(
        (pos) => updateMyLocation(pos.coords.latitude, pos.coords.longitude),
        (err) => console.error("Live location error:", err),
        { enableHighAccuracy: true }
      );
    });
  }

  requestLocationAccess();
</script>
</body>
</html>
